# Task Stack Module

Task Stack ????????????????

- ???`user` / `director` / `subagent`?
- ???task?
- ??layer?
- ?????execution pointer?
- ???????atomic batch updates?

???? API ??????????????????? `director_agent` ???

## 1) ????

Task Stack ???

- ?????????????????????
- ??????????????????????????
- ?????????????hook ???
- ?????`layer_index`?`task_index`?
- ??????????next?????????

Task Stack ????

- sub-agent ?????? `assistant/service.py` ???
- ???????/??/?????? Assistant ?? Workspace ???
- director ??????? `director_agent` ???

## 2) ????

- `models.py`
  - ???????????????????????????
- `storage.py`
  - ????????
  - ?????????
- `routes.py`
  - HTTP ??
  - ??????????????
  - ??????

?????

- `routes.py` ?????????
- `storage.py` ?????????

## 3) ?????

- ???`interface/src/services/api.js`?
  - ??????
  - ?????????????????
- Director?`director_agent/api_client.py`?
  - ????????
  - ?????????/??/???
  - ????????????

## 4) ??????

### ??????

- ?????????
  - `content`
  - `sender_type`
- `sender_type` ????`user`?`director`?`subagent`

### ?????

- ????? `user_id`
- ??????????

### ??????

- `GET /api/messages/<msg_id>/check` ???????
  - `message`
  - `is_new_task`
- ???????????

## 5) API ??????

????? `routes.py` ???????????

### Messages

- `POST /api/messages/create`
- `GET /api/messages/<msg_id>`
- `GET /api/messages/list`
- `GET /api/messages/unread`
- `PUT /api/messages/<msg_id>/read-status`
- `GET /api/messages/<msg_id>/check`

??????

```json
{
  "content": "hello",
  "sender_type": "user"
}
```

### Tasks

- `POST /api/tasks/create`
- `GET /api/tasks/<task_id>`
- `GET /api/tasks/list`
- `PUT /api/tasks/<task_id>`
- `DELETE /api/tasks/<task_id>`
- `PUT /api/tasks/<task_id>/status`
- `POST /api/tasks/<task_id>/messages`

???????

```json
{
  "content": "delegated to StoryAgent",
  "sender_type": "director"
}
```

### Layers

- `POST /api/layers/create`
- `GET /api/layers/list`
- `GET /api/layers/<layer_index>`
- `PUT /api/layers/<layer_index>/hooks`
- `POST /api/layers/<layer_index>/tasks`
- `DELETE /api/layers/<layer_index>/tasks/<task_id>`
- `POST /api/layers/<layer_index>/tasks/replace`

### Pointer ? Stack ??

- `GET /api/execution-pointer/get`
- `PUT /api/execution-pointer/set`
- `POST /api/execution-pointer/advance`
- `GET /api/task-stack`
- `GET /api/task-stack/next`
- `POST /api/task-stack/insert-layer`
- `POST /api/task-stack/modify`????

## 6) ???????

1. ???? `POST /api/messages/create` ???????  
2. Director ?? `GET /api/messages/unread?sender_type=user` ???????  
3. Director ??/?????????  
4. Director ?????????????  
5. Director ??????????????  
6. ????????????????????  

## 7) ??????

### ????????????????

- ???????????????????
- ?????????????????????
- ????????????????????????????

### ????? Layer

- Layer ??????????????? -> ?? -> ???
- ????????????????????

### ?????????

- ?????????????????director ???subagent ???
- ??? UI ????????

## 8) routes ? storage ????????

- Messages?
  - routes?create/list/unread/read-status/check
  - storage??????????????????
- Tasks?
  - routes?create/get/list/update/delete/status/message-append
  - storage???????????????
- Layers?
  - routes?create/list/get/hooks/add-task/remove-task/replace-tasks
  - storage???????????????
- Pointer ? Stack?
  - routes?get/set/advance?snapshot/next/modify
  - storage????????????

???????? `routes.py` ????????? storage ??????

## 9) ????

- `routes.py` ?????? helper ???
  - JSON body ??
  - enum ??
  - bool query ??
  - 400 ?????
- ????????????
- `modify` ??????????????????

## 10) ????

- ???/?????? 400
  - ?? `content`?`sender_type`
  - ?? body ????? JSON
- ????????????
  - ?? `sender_type` ????
  - ????????????
- ????????
  - ?? operation ?????
  - ???????????????
# Task Stack Module

Task Stack ????????????????

- ???`user` / `director` / `subagent`?
- ???task?
- ??layer?
- ?????execution pointer?
- ???????atomic batch updates?

???? API ??????????????????? `director_agent` ???

## 1) ????

Task Stack ???

- ?????????????????????
- ??????????????????????????
- ?????????????hook ???
- ?????`layer_index`?`task_index`?
- ??????????next?????????

Task Stack ????

- sub-agent ?????? `assistant/service.py` ???
- ???????/??/?????? Assistant ?? Workspace ???
- director ??????? `director_agent` ???

## 2) ????

- `models.py`
  - ???????????????????????????
- `storage.py`
  - ????????
  - ?????????
- `routes.py`
  - HTTP ??
  - ??????????????
  - ??????

?????

- `routes.py` ?????????
- `storage.py` ?????????

## 3) ?????

- ???`interface/src/services/api.js`?
  - ??????
  - ?????????????????
- Director?`director_agent/api_client.py`?
  - ????????
  - ?????????/??/???
  - ????????????

## 4) ??????

### ??????

- ?????????
  - `content`
  - `sender_type`
- `sender_type` ????`user`?`director`?`subagent`

### ?????

- ????? `user_id`
- ??????????

### ??????

- `GET /api/messages/<msg_id>/check` ???????
  - `message`
  - `is_new_task`
- ???????????

## 5) API ??????

????? `routes.py` ???????????

### Messages

- `POST /api/messages/create`
- `GET /api/messages/<msg_id>`
- `GET /api/messages/list`
- `GET /api/messages/unread`
- `PUT /api/messages/<msg_id>/read-status`
- `GET /api/messages/<msg_id>/check`

??????

```json
{
  "content": "hello",
  "sender_type": "user"
}
```

### Tasks

- `POST /api/tasks/create`
- `GET /api/tasks/<task_id>`
- `GET /api/tasks/list`
- `PUT /api/tasks/<task_id>`
- `DELETE /api/tasks/<task_id>`
- `PUT /api/tasks/<task_id>/status`
- `POST /api/tasks/<task_id>/messages`

???????

```json
{
  "content": "delegated to StoryAgent",
  "sender_type": "director"
}
```

### Layers

- `POST /api/layers/create`
- `GET /api/layers/list`
- `GET /api/layers/<layer_index>`
- `PUT /api/layers/<layer_index>/hooks`
- `POST /api/layers/<layer_index>/tasks`
- `DELETE /api/layers/<layer_index>/tasks/<task_id>`
- `POST /api/layers/<layer_index>/tasks/replace`

### Pointer ? Stack ??

- `GET /api/execution-pointer/get`
- `PUT /api/execution-pointer/set`
- `POST /api/execution-pointer/advance`
- `GET /api/task-stack`
- `GET /api/task-stack/next`
- `POST /api/task-stack/insert-layer`
- `POST /api/task-stack/modify`????

## 6) ???????

1. ???? `POST /api/messages/create` ???????  
2. Director ?? `GET /api/messages/unread?sender_type=user` ???????  
3. Director ??/?????????  
4. Director ?????????????  
5. Director ??????????????  
6. ????????????????????  

## 7) ??????

### ????????????????

- ???????????????????
- ?????????????????????
- ????????????????????????????

### ????? Layer

- Layer ??????????????? -> ?? -> ???
- ????????????????????

### ?????????

- ?????????????????director ???subagent ???
- ??? UI ????????

## 8) routes ? storage ????????

- Messages?
  - routes?create/list/unread/read-status/check
  - storage??????????????????
- Tasks?
  - routes?create/get/list/update/delete/status/message-append
  - storage???????????????
- Layers?
  - routes?create/list/get/hooks/add-task/remove-task/replace-tasks
  - storage???????????????
- Pointer ? Stack?
  - routes?get/set/advance?snapshot/next/modify
  - storage????????????

???????? `routes.py` ????????? storage ??????

## 9) ????

- `routes.py` ?????? helper ???
  - JSON body ??
  - enum ??
  - bool query ??
  - 400 ?????
- ????????????
- `modify` ??????????????????

## 10) ????

- ???/?????? 400
  - ?? `content`?`sender_type`
  - ?? body ????? JSON
- ????????????
  - ?? `sender_type` ????
  - ????????????
- ????????
  - ?? operation ?????
  - ???????????????
